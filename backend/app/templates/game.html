{% extends "base.html" %}

{% block content %}
<h2>Game</h2>

<!-- Sélection de la tâche -->
<div id="backlog">
    <h3>Backlog</h3>
    <label for="task-select">Choisissez une tâche :</label>
    <select id="task-select" onchange="updateTaskDetails()">
        <option value="" disabled selected>-- Sélectionnez une tâche --</option>
    </select>

    <!-- Détails de la tâche -->
    <div id="task-details" style="margin-top: 20px;">
        <p><strong>Description :</strong> <span id="task-description">---</span></p>
        <p><strong>Estimation :</strong> <span id="task-estimate">---</span></p>
        <p><strong>Votes existants :</strong></p>
        <div id="existing-votes">---</div>
    </div>
</div>

<!-- Sélection du joueur -->
<div id="player-section">
    <h3>Joueur actuel</h3>
    <label for="player-select">Sélectionnez un joueur :</label>
    <select id="player-select">
        <option value="" disabled selected>-- Sélectionnez un joueur --</option>
        {% for player in players %}
            <option value="{{ player }}">{{ player }}</option>
        {% endfor %}
    </select>
    <button onclick="startVote()">Démarrer le vote</button>
</div>

<!-- Section de vote -->
<div id="vote-section" style="display:none;">
    <h3>Vote en cours</h3>
    <p>Joueur : <strong id="current-player">---</strong></p>
    <p>Temps restant : <span id="timer">15</span> secondes</p>

    <div id="choices">
        <img src="static/cartes/cartes_0.svg" alt="0" onclick="selectVote(0)" >
        <img src="/static/cartes/cartes_1.svg" alt="1" onclick="selectVote(1)" >
        <img src="/static/cartes/cartes_2.svg" alt="2" onclick="selectVote(2)" >
        <img src="/static/cartes/cartes_3.svg" alt="3" onclick="selectVote(3)" >
        <img src="/static/cartes/cartes_5.svg" alt="5" onclick="selectVote(5)" >
        <img src="/static/cartes/cartes_8.svg" alt="8" onclick="selectVote(8)" >
        <img src="/static/cartes/cartes_13.svg" alt="13" onclick="selectVote(13)" >
        <img src="/static/cartes/cartes_20.svg" alt="20" onclick="selectVote(20)" >
        <img src="/static/cartes/cartes_40.svg" alt="40" onclick="selectVote(40)" >
        <img src="/static/cartes/cartes_100.svg" alt="100" onclick="selectVote(100)">
    </div>
    <button id="submit-vote" onclick="submitVote()" disabled>Soumettre</button>
</div>

<!-- Validation -->
<div id="validate-section" style="display:none;">
    <h3>Tous les joueurs ont voté !</h3>
    <button onclick="validateVotes()">Valider les votes</button>
</div>

<script>
    let selectedTaskId = null;
    let selectedPlayer = null;
    let selectedVote = null;
    let timer = 15;
    let interval;
    let backlogData = {};

    async function refreshBacklog() {
        const response = await fetch("/backlog");
        if (response.ok) {
            const data = await response.json();
            backlogData = data.backlog;
            updateBacklogUI(backlogData);
        } else {
            console.error("Erreur lors de la récupération du backlog mis à jour");
        }
    }

    function updateBacklogUI(backlog) {
        const select = document.getElementById("task-select");
        select.innerHTML = '<option value="" disabled selected>-- Sélectionnez une tâche --</option>';
        
        backlog.forEach(task => {
            const option = document.createElement("option");
            option.value = task.id;
            option.textContent = `${task.id} - ${task.title}`;
            option.setAttribute("data-description", task.description);
            option.setAttribute("data-estimate", task.estimatedPoints);
            select.appendChild(option);
        });

        updateTaskDetails();
    }

    function updateTaskDetails() {
        const select = document.getElementById("task-select");
        const selectedOption = select.options[select.selectedIndex];
        if (selectedOption) {
            document.getElementById("task-description").textContent = selectedOption.getAttribute("data-description");
            document.getElementById("task-estimate").textContent = selectedOption.getAttribute("data-estimate");
            selectedTaskId = selectedOption.value;

            // Afficher les votes existants
            const task = backlogData.find(t => t.id === selectedTaskId);
            const votesDisplay = document.getElementById("existing-votes");
            if (task && task.votes) {
                const votesList = Object.entries(task.votes).map(([player, estimate]) => `${player}: ${estimate}`);
                votesDisplay.innerHTML = votesList.join("<br>");
            } else {
                votesDisplay.innerHTML = "Aucun vote pour le moment";
            }
        } else {
            document.getElementById("task-description").textContent = "---";
            document.getElementById("task-estimate").textContent = "---";
            document.getElementById("existing-votes").innerHTML = "---";
            selectedTaskId = null;
        }
    }

    function hasPlayerVoted(taskId, player) {
        const task = backlogData.find(t => t.id === taskId);
        return task && task.votes && task.votes.hasOwnProperty(player);
    }

    async function startVote() {
        const playerSelect = document.getElementById("player-select");
        selectedPlayer = playerSelect.value;

        if (!selectedTaskId || !selectedPlayer) {
            alert("Veuillez sélectionner une tâche et un joueur !");
            return;
        }

        if (hasPlayerVoted(selectedTaskId, selectedPlayer)) {
            alert("Ce joueur a déjà voté pour cette tâche !");
            return;
        }

        document.getElementById("current-player").textContent = selectedPlayer;
        document.getElementById("vote-section").style.display = "block";
        startTimer();
    }

    function startTimer() {
        timer = 15;
        document.getElementById("timer").textContent = timer;
        interval = setInterval(() => {
            timer--;
            document.getElementById("timer").textContent = timer;
            if (timer === 0) {
                submitVote();
            }
        }, 1000);
    }

    function selectVote(vote) {
        selectedVote = vote;
        document.getElementById("submit-vote").disabled = false;
    }

    async function submitVote() {
        clearInterval(interval);

        if (hasPlayerVoted(selectedTaskId, selectedPlayer)) {
            alert("Ce joueur a déjà voté pour cette tâche !");
            document.getElementById("vote-section").style.display = "none";
            return;
        }

        const response = await fetch("/vote", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                task_id: selectedTaskId,
                player: selectedPlayer,
                estimate: selectedVote
            })
        });

        if (response.ok) {
            alert("Vote enregistré !");
            document.getElementById("vote-section").style.display = "none";
            selectedVote = null;
            document.getElementById("submit-vote").disabled = true;
            await refreshBacklog();
        } else {
            const errorData = await response.json();
            alert(errorData.error || "Erreur lors de l'enregistrement du vote.");
        }
    }

    function validateVotes() {
        alert("Votes validés pour la tâche actuelle !");
        document.getElementById("validate-section").style.display = "none";
    }

    // Appelez refreshBacklog au chargement de la page
    document.addEventListener('DOMContentLoaded', refreshBacklog);
</script>
{% endblock %}
